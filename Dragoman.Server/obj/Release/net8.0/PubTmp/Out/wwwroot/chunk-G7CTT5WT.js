import{a as W}from"./chunk-GRZSBS6E.js";import{$ as S,A as u,Aa as I,Ba as U,Ca as $,D as x,Da as q,E as g,F as m,Ga as B,H as o,I as v,Ia as Y,Ja as z,P as E,Q as P,W as T,X as k,ja as D,ka as y,la as w,ma as A,na as V,o as O,oa as f,pa as j,q as h,qa as N,r as p,ra as M,t as c,ta as F,u as C,ua as J,v as _,w as d,wa as R,xa as H,y as r,ya as G,z as n,za as L}from"./chunk-UPQ5EB2H.js";var K=()=>({exact:!0});function Q(a,s){if(a&1){let e=x();r(0,"tr",32)(1,"td"),u(2,"input",33),n(),r(3,"td"),u(4,"input",34),n(),r(5,"td"),u(6,"input",35),n(),r(7,"td"),u(8,"input",36),n(),r(9,"td")(10,"button",25),g("click",function(){let i=h(e).index,l=m(2);return p(l.supprimerTicket(i))}),o(11,"\u{1F5D1}\uFE0F"),n()()()}if(a&2){let e=s.index;d("formGroupName",e)}}function X(a,s){if(a&1){let e=x();r(0,"tr",32)(1,"td"),u(2,"input",37),n(),r(3,"td"),u(4,"input",36),n(),r(5,"td")(6,"button",25),g("click",function(){let i=h(e).index,l=m(2);return p(l.supprimerAutreTache(i))}),o(7,"\u{1F5D1}\uFE0F"),n()()()}if(a&2){let e=s.index;d("formGroupName",e)}}function Z(a,s){if(a&1){let e=x();r(0,"div",8)(1,"h2"),o(2,"Fiche Helpdesk \u2014 Jour"),n(),r(3,"div",9),o(4," Utilisateur: "),r(5,"b"),o(6),n()(),r(7,"form",10)(8,"div",11)(9,"div",12)(10,"div",13),o(11,"Date"),n(),u(12,"input",14),n(),r(13,"div",12)(14,"div",13),o(15,"R\xE9gime de travail"),n(),r(16,"select",15)(17,"option",16),o(18,"Mi-temps"),n(),r(19,"option",17),o(20,"Temps plein"),n(),r(21,"option",18),o(22,"Autre"),n()()(),r(23,"div",19)(24,"label",20),u(25,"input",21),o(26," Je suis de garde "),n()()(),r(27,"h3"),o(28,"Tickets"),n(),r(29,"table",22)(30,"thead")(31,"tr")(32,"th"),o(33,"Heure"),n(),r(34,"th"),o(35,"N\xB0"),n(),r(36,"th"),o(37,"Description"),n(),r(38,"th"),o(39,"Dur\xE9e (min)"),n(),u(40,"th"),n()(),r(41,"tbody",23),_(42,Q,12,1,"tr",24),n()(),r(43,"button",25),g("click",function(){h(e);let i=m();return p(i.ajouterTicket())}),o(44,"\u2795 Ajouter un ticket"),n(),r(45,"h3"),o(46,"Autres t\xE2ches"),n(),r(47,"table",22)(48,"thead")(49,"tr")(50,"th"),o(51,"Description"),n(),r(52,"th"),o(53,"Dur\xE9e (min)"),n(),u(54,"th"),n()(),r(55,"tbody",26),_(56,X,8,1,"tr",24),n()(),r(57,"button",25),g("click",function(){h(e);let i=m();return p(i.ajouterAutreTache())}),o(58,"\u2795 Ajouter une t\xE2che"),n(),r(59,"div",27)(60,"label"),o(61,"Remarques"),n(),u(62,"textarea",28),n(),r(63,"div",29)(64,"button",30),g("click",function(){h(e);let i=m();return p(i.enregistrerJour())}),o(65,"\u{1F4BE} Enregistrer"),n(),r(66,"span",31),o(67),n()()()()}if(a&2){let e=m();c(6),v(e.user),c(),d("formGroup",e.formulaire),c(35),d("ngForOf",e.tickets.controls),c(14),d("ngForOf",e.autresTaches.controls),c(8),d("disabled",e.enregistrementEnCours),c(3),v(e.messageSauvegarde)}}function b(a){let s=e=>e.toString().padStart(2,"0");return`${a.getFullYear()}-${s(a.getMonth()+1)}-${s(a.getDate())}`}function ee(a){let s=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())),e=(s.getUTCDay()+6)%7;s.setUTCDate(s.getUTCDate()-e+3);let t=new Date(Date.UTC(s.getUTCFullYear(),0,4)),i=(s.getTime()-t.getTime())/864e5,l=1+Math.floor(i/7);return`${s.getUTCFullYear()}-W${l.toString().padStart(2,"0")}`}var ce=(()=>{class a{constructor(e,t,i){this.fb=e,this.authService=t,this.hdSvc=i,this.user="",this.enregistrementEnCours=!1,this.messageSauvegarde="",this.aujourdHui=new Date}ngOnInit(){this.construireFormulaire(),this.authService.getLogin().subscribe(e=>{this.user=e||"anonymous",this.chargerJourCourant()}),this.formulaire.get("hdDate").valueChanges.subscribe(e=>{for(let t of this.tickets.controls)t.get("date").setValue(e,{emitEvent:!1});for(let t of this.autresTaches.controls)t.get("date").setValue(e,{emitEvent:!1});this.chargerJourCourant()})}construireFormulaire(){this.formulaire=this.fb.group({hdDate:new M(b(this.aujourdHui),{nonNullable:!0}),hdRegimeTravail:new M("temps plein",{nonNullable:!0}),hdEnGarde:[!1],hdTickets:this.fb.array([]),hdAutresTaches:this.fb.array([]),hdRemarquesCollaborateur:[""]});for(let e=0;e<1;e++)this.ajouterTicket();this.ajouterAutreTache()}get tickets(){return this.formulaire.get("hdTickets")}get autresTaches(){return this.formulaire.get("hdAutresTaches")}ajouterTicket(){let e=this.formulaire?.value?.hdDate||b(this.aujourdHui);this.tickets.push(this.fb.group({date:[e],heure:[""],numero:[""],type:[""],dureeMin:[0,[f.min(0)]]}))}supprimerTicket(e){e>=0&&e<this.tickets.length&&this.tickets.removeAt(e)}ajouterAutreTache(){let e=this.formulaire?.value?.hdDate||b(this.aujourdHui);this.autresTaches.push(this.fb.group({denomination:[""],date:[e],dureeMin:[0,[f.min(0)]]}))}supprimerAutreTache(e){e>=0&&e<this.autresTaches.length&&this.autresTaches.removeAt(e)}parseGardeVersForm(e){this.formulaire.patchValue({hdEnGarde:!!(e&&e.trim().toLowerCase().startsWith("oui"))},{emitEvent:!1})}remettreTableauxVides(){let e=this.formulaire.get("hdDate").value;this.tickets.clear(),this.autresTaches.clear();for(let t=0;t<2;t++)this.ajouterTicket();this.autresTaches.push(this.fb.group({denomination:[""],date:[e],dureeMin:[0,[f.min(0)]]})),this.formulaire.patchValue({hdRemarquesCollaborateur:"",hdEnGarde:!1},{emitEvent:!1})}reinjecterJour(e){this.formulaire.patchValue({hdDate:e.hdDate,hdRegimeTravail:e.hdRegimeTravail||"temps plein",hdRemarquesCollaborateur:e.hdRemarquesCollaborateur||""},{emitEvent:!1}),this.parseGardeVersForm(e.hdGarde);let t=e.hdDate;this.tickets.clear(),(e.hdTickets||[]).forEach(i=>this.tickets.push(this.fb.group({date:[t],heure:[i.heure||""],numero:[i.numero||""],type:[i.type||""],dureeMin:[i.dureeMin??0,[f.min(0)]]}))),this.tickets.length===0&&this.ajouterTicket(),this.autresTaches.clear(),(e.hdAutresTaches||[]).forEach(i=>this.autresTaches.push(this.fb.group({denomination:[i.denomination||""],date:[t],dureeMin:[i.dureeMin??0,[f.min(0)]]}))),this.autresTaches.length===0&&this.ajouterAutreTache()}chargerJourCourant(){if(!this.user)return;let e=this.formulaire.get("hdDate").value;this.hdSvc.lireJour(this.user,e).subscribe({next:t=>{t&&t.hdDate===e?(this.reinjecterJour(t),this.messageSauvegarde="\u{1F4D6} Donn\xE9es du jour recharg\xE9es."):(this.remettreTableauxVides(),this.messageSauvegarde="\u2139\uFE0F Aucune donn\xE9e pour ce jour \u2014 tableaux vid\xE9s.")},error:()=>{this.remettreTableauxVides(),this.messageSauvegarde="\u26A0\uFE0F Impossible de recharger la journ\xE9e."}})}construireChampGarde(){return this.formulaire.value.hdEnGarde?"oui":void 0}nettoyerTicketsVides(){for(let e=this.tickets.length-1;e>=0;e--){let t=this.tickets.at(e).value;!t.heure&&!t.numero&&!t.type&&(!t.dureeMin||t.dureeMin===0)&&this.tickets.removeAt(e)}}nettoyerAutresVides(){for(let e=this.autresTaches.length-1;e>=0;e--){let t=this.autresTaches.at(e).value;!t.denomination&&(!t.dureeMin||t.dureeMin===0)&&this.autresTaches.removeAt(e)}}construireDto(){let e=new Date(this.formulaire.value.hdDate),t=b(e);for(let i of this.tickets.controls)i.get("date").setValue(t,{emitEvent:!1});for(let i of this.autresTaches.controls)i.get("date").setValue(t,{emitEvent:!1});return{hdUser:this.user,hdDate:t,hdSemaineISO:ee(e),hdRegimeTravail:this.formulaire.value.hdRegimeTravail,hdGarde:this.construireChampGarde(),hdTickets:this.formulaire.value.hdTickets||[],hdAutresTaches:this.formulaire.value.hdAutresTaches||[],hdRemarquesCollaborateur:this.formulaire.value.hdRemarquesCollaborateur||void 0}}normaliserChampsAvantSave(){this.tickets.controls.forEach(e=>{let t=(e.get("numero")?.value||"").trim();(e.get("type")?.value||"").trim()||e.get("type").setValue(t?`Ticket ${t}`:"Ticket",{emitEvent:!1})}),this.autresTaches.controls.forEach(e=>{(e.get("denomination")?.value||"").trim()||e.get("denomination").setValue("Autre t\xE2che",{emitEvent:!1})})}enregistrerJour(){let e={t:this.tickets.length,a:this.autresTaches.length};this.nettoyerTicketsVides(),this.nettoyerAutresVides(),this.normaliserChampsAvantSave();let t=this.construireDto();this.enregistrementEnCours=!0,this.messageSauvegarde="Enregistrement...",this.hdSvc.enregistrerJour(t).subscribe({next:i=>{for(this.messageSauvegarde=i.ok?"\u2705 Enregistr\xE9":`\u26A0\uFE0F ${i.message||"\xC9chec enregistrement"}`,this.enregistrementEnCours=!1,this.chargerJourCourant();this.tickets.length<Math.max(1,e.t);)this.ajouterTicket();for(;this.autresTaches.length<Math.max(1,e.a);)this.ajouterAutreTache()},error:i=>{this.messageSauvegarde=`\u274C Erreur: ${i instanceof Error?i.message:String(i)}`,this.enregistrementEnCours=!1}})}exporterJsonLocal(){let e=this.construireDto(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),l=document.createElement("a");l.href=i,l.download=`${e.hdUser}_${e.hdSemaineISO}_${e.hdDate}.json`,l.click(),URL.revokeObjectURL(i)}static{this.\u0275fac=function(t){return new(t||a)(C(B),C(z),C(W))}}static{this.\u0275cmp=O({type:a,selectors:[["app-hd-prestation-jour"]],standalone:!0,features:[E],decls:14,vars:3,consts:[["role","navigation","aria-label","Helpdesk navigation",1,"navbar--glass"],[1,"nav-left"],[1,"logo"],["routerLink","/hd","routerLinkActive","active",3,"routerLinkActiveOptions"],["routerLink","/hd/fiche-jour","routerLinkActive","active"],["routerLink","/hd/recap-semaine","routerLinkActive","active"],[1,"nav-right"],["class","hd-carte",4,"ngIf"],[1,"hd-carte"],[1,"hd-meta"],[1,"form-grid",3,"formGroup"],[1,"mini-cards"],[1,"mini-card"],[1,"mini-label"],["type","date","formControlName","hdDate"],["formControlName","hdRegimeTravail"],["value","mi-temps"],["value","temps plein"],["value","autre"],[1,"mini-card","mini-guard"],[1,"inline"],["type","checkbox","formControlName","hdEnGarde"],[1,"hd-table"],["formArrayName","hdTickets"],[3,"formGroupName",4,"ngFor","ngForOf"],["type","button",3,"click"],["formArrayName","hdAutresTaches"],[1,"row"],["formControlName","hdRemarquesCollaborateur","rows","2"],[1,"actions"],["type","button",3,"click","disabled"],[1,"muted"],[3,"formGroupName"],["type","time","formControlName","heure"],["type","text","formControlName","numero"],["type","text","formControlName","type"],["type","number","min","0","formControlName","dureeMin"],["type","text","formControlName","denomination"]],template:function(t,i){t&1&&(r(0,"nav",0)(1,"div",1)(2,"span",2),o(3,"Helpdesk CCE"),n(),r(4,"a",3),o(5,"HD"),n(),r(6,"a",4),o(7,"Prestation journali\xE8re"),n(),r(8,"a",5),o(9,"Semaine"),n()(),r(10,"div",6)(11,"span"),o(12,"Bienvenue"),n()()(),_(13,Z,68,6,"div",7)),t&2&&(c(4),d("routerLinkActiveOptions",P(2,K)),c(9),d("ngIf",i.formulaire))},dependencies:[S,T,k,Y,F,U,$,V,J,A,I,j,N,q,R,L,H,G,w,D,y],styles:[".hd-carte[_ngcontent-%COMP%]{background:#fff;border-radius:12px;padding:20px;box-shadow:0 6px 18px #0000000f;border:1px solid #e5e7eb}.hd-carte[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0 0 6px;font-size:22px}.hd-meta[_ngcontent-%COMP%]{margin-bottom:16px;opacity:.85;color:#374151}.mini-cards[_ngcontent-%COMP%]{display:grid;gap:12px;margin-bottom:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}.mini-card[_ngcontent-%COMP%]{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;display:grid;gap:8px}.mini-card[_ngcontent-%COMP%]   .mini-label[_ngcontent-%COMP%]{font-weight:600;color:#374151;font-size:14px}.mini-card[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .mini-card[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;outline:none;background:#fff;width:100%}.mini-card.mini-guard[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center}.inline[_ngcontent-%COMP%]{display:inline-flex;gap:8px;align-items:center}.form-grid[_ngcontent-%COMP%]{display:grid;gap:12px}.form-grid[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{display:grid;grid-template-columns:200px 1fr;align-items:center;gap:12px}.form-grid[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-weight:600}.form-grid[_ngcontent-%COMP%]   input[type=date][_ngcontent-%COMP%], .form-grid[_ngcontent-%COMP%]   input[type=time][_ngcontent-%COMP%], .form-grid[_ngcontent-%COMP%]   input[type=text][_ngcontent-%COMP%], .form-grid[_ngcontent-%COMP%]   input[type=number][_ngcontent-%COMP%], .form-grid[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], .form-grid[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;outline:none;background:#fff}.form-grid[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{resize:vertical}.hd-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;margin:8px 0 14px}.hd-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .hd-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:1px solid #e5e7eb;padding:8px}.hd-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background:#f8fafc;text-align:left;font-weight:600}.hd-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;box-sizing:border-box}button[_ngcontent-%COMP%]{border:none;border-radius:8px;padding:10px 14px;cursor:pointer;background:#2563eb;color:#fff;transition:filter .12s ease,transform .06s ease}button[_ngcontent-%COMP%]:hover{filter:brightness(1.05)}button[_ngcontent-%COMP%]:active{transform:translateY(1px)}button[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.hd-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:6px 10px;border-radius:6px;background:#ef4444}.hd-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{filter:brightness(1.05)}.form-grid[_ngcontent-%COMP%] > button[type=button][_ngcontent-%COMP%]{margin:2px 0 12px;background:#334155}.form-grid[_ngcontent-%COMP%] > button[type=button][_ngcontent-%COMP%]:hover{filter:brightness(1.05)}.actions[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}.actions[_ngcontent-%COMP%]   .muted[_ngcontent-%COMP%]{opacity:.8;color:#6b7280}[_ngcontent-%COMP%]:where(input, select[_ngcontent-%COMP%], textarea[_ngcontent-%COMP%], button)[_ngcontent-%COMP%]:focus-visible{outline:2px solid #93c5fd;outline-offset:1px}@media (max-width:700px){.form-grid[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{grid-template-columns:1fr;align-items:start}}"]})}}return a})();export{ce as HDPrestationJourComponent};
